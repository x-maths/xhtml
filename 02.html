<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°å­¦å†’é™©ï¼šç®€ä¾¿è¿ç®—é­”æ³•å­¦é™¢</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@2.1.1/lib/p5.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Orbitron', 'PingFang SC', sans-serif;
            transition: all 0.3s ease;
            font-size: 16px;
        }
        
        /* æ˜æš—ä¸»é¢˜å˜é‡ */
        .light-theme {
            --bg-primary: #f0f4ff;
            --bg-secondary: #ffffff;
            --text-primary: #1a1a2e;
            --text-secondary: #4a5568;
            --accent-1: #00d4ff;
            --accent-2: #7c3aed;
            --accent-3: #f59e0b;
            --border-glow: rgba(0, 212, 255, 0.15);
            --border-line: rgba(0, 212, 255, 0.2);
            --card-shadow: rgba(0, 0, 0, 0.05);
        }
        
        .dark-theme {
            --bg-primary: #0a0e27;
            --bg-secondary: #161b33;
            --text-primary: #e0e7ff;
            --text-secondary: #a5b4fc;
            --accent-1: #00ffff;
            --accent-2: #a855f7;
            --accent-3: #fbbf24;
            --border-glow: rgba(0, 255, 255, 0.2);
            --border-line: rgba(0, 255, 255, 0.3);
            --card-shadow: rgba(0, 255, 255, 0.1);
        }
        
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .cyber-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-line);
            box-shadow: 0 0 20px var(--card-shadow), inset 0 0 20px rgba(124, 58, 237, 0.05);
            position: relative;
            overflow: hidden;
        }
        
        .cyber-card::before {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            right: -1px;
            bottom: -1px;
            background: linear-gradient(45deg, var(--accent-1), var(--accent-2), var(--accent-1));
            z-index: -1;
            filter: blur(10px);
            opacity: 0.15;
            animation: glow 3s ease-in-out infinite;
        }
        
        @keyframes glow {
            0%, 100% { opacity: 0.15; }
            50% { opacity: 0.3; }
        }
        
        .neon-text {
            text-shadow: 0 0 10px var(--border-glow);
        }
        
        .game-btn {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(124, 58, 237, 0.1));
            border: 1px solid var(--border-line);
            color: var(--text-primary);
            box-shadow: 0 0 10px var(--border-glow);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .game-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }
        
        .game-btn:hover::before {
            left: 100%;
        }
        
        .game-btn:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(124, 58, 237, 0.2));
            box-shadow: 0 0 15px var(--border-glow);
            border-color: var(--accent-1);
        }
        
        .game-btn:active {
            transform: translateY(0);
        }

        .game-btn.correct {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.2);
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.4);
        }

        .game-btn.wrong {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.2);
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .hologram {
            background: linear-gradient(135deg, rgba(0,212,255,0.05), rgba(124,58,237,0.05));
            backdrop-filter: blur(5px);
            border: 1px solid var(--border-line);
        }
        
        .theme-toggle {
            width: 60px;
            height: 30px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-line);
            border-radius: 15px;
            position: relative;
            cursor: pointer;
            box-shadow: 0 0 5px var(--border-glow);
        }
        
        .theme-toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 0 5px var(--accent-1);
        }
        
        .theme-toggle.active .theme-toggle-slider {
            transform: translateX(30px);
        }
        
        .scan-line {
            position: absolute;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--border-line), transparent);
            animation: scan 3s linear infinite;
            opacity: 0.5;
        }
        
        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }
        
        .star-field {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
            opacity: 0.6;
        }
        
        input[type="text"] {
            background: var(--bg-secondary);
            border: 1px solid var(--border-line);
            color: var(--text-primary);
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
        }
        
        input[type="text"]:focus {
            border-color: var(--accent-1);
            outline: none;
        }
        
        input[type="text"]::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }
        
        .dialogue-box {
            position: relative;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .teacher-msg {
            background: linear-gradient(135deg, rgba(124,58,237,0.1), rgba(168,85,247,0.1));
            border-left: 2px solid var(--accent-2);
        }
        
        .student-msg {
            background: linear-gradient(135deg, rgba(0,212,255,0.1), rgba(0,255,255,0.1));
            border-right: 2px solid var(--accent-1);
        }
        
        .hp-bar {
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--border-line);
            overflow: hidden;
        }
        
        .hp-fill {
            background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
            height: 100%;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 10px var(--accent-1);
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-forward;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* éŸ³é¢‘æŒ‰é’®æ—‹è½¬åŠ¨ç”» */
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .rotating {
            animation: rotate 2s linear infinite;
        }

        /* p5.js å¯è§†åŒ–å®¹å™¨ */
        .p5-visualization {
            background: rgba(0,0,0,0.2);
            border-radius: 0.75rem;
            overflow: hidden;
        }
    </style>
</head>
<body class="dark-theme">
    <script>
        // æ ¹æ®URLå‚æ•°åŠ è½½ä¸»é¢˜
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const theme = urlParams.get('theme');
            
            if (theme === 'light') {
                document.body.classList.remove('dark-theme');
                document.body.classList.add('light-theme');
            } else if (theme === 'dark') {
                document.body.classList.remove('light-theme');
                document.body.classList.add('dark-theme');
            }
        })();
    </script>
    <div id="star-field" class="star-field"></div>
    
    <!-- æ¸¸æˆç•Œé¢é¡¶éƒ¨ -->
    <div class="sticky top-0 z-50 cyber-card rounded-b-3xl" style="position: sticky; top: 0;">
        <div class="p-4">
            
            <!-- æ¸¸æˆæ ‡é¢˜ -->
            <h1 class="text-2xl font-black text-center neon-text mb-2">
                æ•°å­¦å†’é™©ï¼šç®€ä¾¿è¿ç®—é­”æ³•å­¦é™¢
            </h1>
            <p class="text-base text-center" style="color: var(--text-secondary)">
                [ MISSION: æŒæ¡è®¡ç®—é­”æ³•çš„ç»ˆææŠ€å·§ ]
            </p>
            
            <!-- èƒ½é‡æ¡ -->
            <div class="mt-4">
                <div class="flex justify-between text-sm mb-1" style="color: var(--text-secondary)">
                    <span>é­”æ³•èƒ½é‡</span>
                    <span id="energy-text">0 / 100</span>
                </div>
                <div class="hp-bar rounded-full h-4">
                    <div id="energy-bar" class="hp-fill rounded-full" style="width: 0%"></div>
                </div>
            </div>

            <!-- éŸ³é¢‘æ’­æ”¾å™¨ï¼ˆéšè—ï¼‰ -->
            <audio id="bg-audio" style="display: none;">
                <source src="https://cdn.jsdelivr.net/gh/x-maths/xhtml@20251209/audio/L1_02.wav" type="audio/wav">
            </audio>
        </div>
    </div>

    <!-- éŸ³é¢‘æ§åˆ¶æŒ‰é’®ï¼ˆå³ä¸‹è§’ï¼‰ -->
    <div id="audio-control" onclick="toggleAudio()" style="position: fixed; bottom: 80px; right: 20px; z-index: 40; cursor: pointer; width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-1), var(--accent-2)); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 20px var(--border-glow); transition: all 0.3s ease;">
        <span style="font-size: 28px;">ğŸµ</span>
    </div>

    <div class="max-w-md mx-auto px-4 py-6 space-y-6 pb-24">
        <!-- ä»»åŠ¡ç®€æŠ¥ -->
        <div class="cyber-card rounded-2xl p-5 relative">
            <div class="scan-line"></div>
            <div class="flex items-center gap-3 mb-3">
                <div class="w-10 h-10 rounded-full" style="background: linear-gradient(135deg, var(--accent-1), var(--accent-2)); display: flex; align-items: center; justify-content: center;">
                    <span class="text-xl">ğŸ¯</span>
                </div>
                <h2 class="text-xl font-bold">ä»»åŠ¡ç®€æŠ¥</h2>
            </div>
            <div class="space-y-2 text-base" style="color: var(--text-secondary)">
                <p>é­”æ³•å­¦å¾’ï¼Œæ¬¢è¿æ¥åˆ°ç®€ä¾¿è¿ç®—é­”æ³•å­¦é™¢ï¼</p>
                <p>å®Œæˆå¯¹è¯ç‰¹è®­ï¼ŒæŒæ¡è®¡ç®—é­”æ³•çš„ç»ˆææŠ€å·§ï¼</p>
            </div>
        </div>

        <!-- å‰§æƒ…æµ -->
        <div class="space-y-6">
            
            <!-- STAGE 1: å¼•å…¥é­”æ³• -->
            <div class="space-y-4 fade-in">
                <div class="dialogue-box teacher-msg rounded-xl p-4">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-2)">è€å¸ˆ</div>
                    <p class="text-base leading-relaxed">åŒå­¦ä»¬ï¼Œä½ ä»¬å–œæ¬¢ç©é­”æœ¯å—ï¼Ÿæ•°å­¦é‡Œä¹Ÿæœ‰ä¸€äº›å°é­”æœ¯ï¼Œèƒ½è®©æˆ‘ä»¬çš„è®¡ç®—å˜å¾—åˆå¿«åˆå‡†ã€‚ä»Šå¤©æˆ‘ä»¬å°±æ¥å­¦ä¹ "ç®€ä¾¿è¿ç®—"è¿™ä¸ªé­”æ³•ã€‚</p>
                </div>
                <div class="dialogue-box student-msg rounded-xl p-4 ml-8">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-1)">å­¦ç”Ÿ</div>
                    <p class="text-base leading-relaxed">å“‡ï¼Œæ•°å­¦é­”æœ¯ï¼æ˜¯ä»€ä¹ˆå‘€ï¼Ÿ</p>
                </div>
                <div class="dialogue-box teacher-msg rounded-xl p-4">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-2)">è€å¸ˆ</div>
                    <p class="text-base leading-relaxed">"ç®€ä¾¿è¿ç®—"å‘€ï¼Œå°±æ˜¯å½“æˆ‘ä»¬æœ‰å¾ˆå¤šæ•°å­—è¦åŠ å‡ä¹˜é™¤çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸æ”¹å˜å®ƒä»¬æœ€åçš„ç»“æœï¼Œä½†æ˜¯é€šè¿‡ä¸€äº›å°çªé—¨ï¼Œè®©è®¡ç®—è¿‡ç¨‹å˜å¾—æ›´å®¹æ˜“ï¼Œä¹Ÿæ›´å¿«ã€‚å°±åƒèµ°ä¸€æ¡æ›´è¿‘çš„è·¯ä¸€æ ·ã€‚</p>
                </div>
                <div class="dialogue-box student-msg rounded-xl p-4 ml-8">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-1)">å­¦ç”Ÿ</div>
                    <p class="text-base leading-relaxed">å“¦ï¼Œå°±æ˜¯æ‰¾ä¸€æ¡è¿‘è·¯ç®—é¢˜å—ï¼Ÿ</p>
                </div>
                <div class="dialogue-box teacher-msg rounded-xl p-4">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-2)">è€å¸ˆ</div>
                    <p class="text-base leading-relaxed">å¯¹ï¼é‚£æˆ‘ä»¬å…ˆæ¥çœ‹ç¬¬ä¸€ä¸ªå°çªé—¨ï¼Œå«åš"å‡‘åå‡‘ç™¾"ã€‚ä½ è§‰å¾—"å‡‘å"æ˜¯ä»€ä¹ˆæ„æ€å‘€ï¼Ÿ</p>
                </div>
                <div class="dialogue-box student-msg rounded-xl p-4 ml-8">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-1)">å­¦ç”Ÿ</div>
                    <p class="text-base leading-relaxed">å—¯â€¦â€¦æ˜¯ä¸æ˜¯æŠŠæ•°å­—åŠ èµ·æ¥å˜æˆåï¼Ÿ</p>
                </div>
                <div class="dialogue-box teacher-msg rounded-xl p-4">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-2)">è€å¸ˆ</div>
                    <p class="text-base leading-relaxed">çœŸèªæ˜ï¼å°±æ˜¯æŠŠèƒ½åŠ èµ·æ¥å˜æˆåã€å˜æˆä¸€ç™¾ã€ç”šè‡³å˜æˆä¸€åƒçš„æ•°ï¼Œå…ˆç®—åœ¨ä¸€èµ·ã€‚æ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬è¦ç®—å…«åŠ äº”åŠ äºŒï¼Œä½ ä¼šæ€ä¹ˆç®—å‘¢ï¼Ÿ</p>
                </div>
                <div class="dialogue-box student-msg rounded-xl p-4 ml-8">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-1)">å­¦ç”Ÿ</div>
                    <p class="text-base leading-relaxed">å…«åŠ äº”ç­‰äºåä¸‰ï¼Œåä¸‰åŠ äºŒç­‰äºåäº”ã€‚</p>
                </div>
                <div class="dialogue-box teacher-msg rounded-xl p-4">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-2)">è€å¸ˆ</div>
                    <p class="text-base leading-relaxed">ç®—å¾—æ²¡é”™ï¼ä½†æ˜¯æˆ‘ä»¬è¯•è¯•å‡‘åã€‚å…«å’ŒäºŒåŠ èµ·æ¥æ˜¯å¤šå°‘å‘€ï¼Ÿ</p>
                </div>
                <div class="dialogue-box student-msg rounded-xl p-4 ml-8">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-1)">å­¦ç”Ÿ</div>
                    <p class="text-base leading-relaxed">å…«åŠ äºŒç­‰äºåï¼</p>
                </div>
                <div class="dialogue-box teacher-msg rounded-xl p-4">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-2)">è€å¸ˆ</div>
                    <p class="text-base leading-relaxed">å¯¹å•¦ï¼Œé‚£åå†åŠ äº”å‘¢ï¼Ÿ</p>
                </div>
                <div class="dialogue-box student-msg rounded-xl p-4 ml-8">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-1)">å­¦ç”Ÿ</div>
                    <p class="text-base leading-relaxed">ç­‰äºåäº”ï¼å“‡ï¼Œè¿™æ ·ç®—çœŸçš„å¿«ï¼</p>
                </div>

                <!-- p5.js å‡‘ååŠ¨ç”»æ¼”ç¤º -->
                <div class="cyber-card rounded-2xl p-4 my-4">
                    <div class="text-center mb-3">
                        <span class="text-md font-bold" style="color: var(--accent-1)">ğŸ“Š é­”æ³•æ¼”ç¤ºï¼šå‡‘åæ³•</span>
                    </div>
                    <div id="grouping-demo" class="p5-visualization" style="max-width: 100%; margin: 0 auto;"></div>
                    <div class="text-center mt-3 text-base" style="color: var(--text-secondary)">
                        8 + 5 + 2 = (8 + 2) + 5 = 10 + 5 = 15
                    </div>
                </div>

                <!-- æ’å…¥ å…³å¡ 1 -->
                <div class="cyber-card rounded-2xl p-4 mt-6 border border-dashed border-opacity-50" style="border-color: var(--accent-3);">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-base font-bold text-yellow-400">âš¡ é­”æ³•æµ‹è¯• 1: å‡‘æ•´æŒ‘æˆ˜</span>
                        <span class="text-sm px-2 py-1 rounded bg-yellow-400/20 text-yellow-400">+25 EXP</span>
                    </div>
                    <div class="text-base mb-4 text-center">
                        <p class="mb-2">27 + 48 + 3 + 2 = ?</p>
                        <p class="text-sm text-gray-400">æ‰¾å‡ºèƒ½å‡‘æ•´çš„æ•°å­—ç»„åˆï¼</p>
                    </div>
                    <div id="level-1-options" class="grid grid-cols-2 gap-2">
                        <button onclick="checkAnswer(1, 70)" class="game-btn py-3 rounded-lg font-bold text-lg">70</button>
                        <button onclick="checkAnswer(1, 80)" class="game-btn py-3 rounded-lg font-bold text-lg">80</button>
                        <button onclick="checkAnswer(1, 75)" class="game-btn py-3 rounded-lg font-bold text-lg">75</button>
                        <button onclick="checkAnswer(1, 85)" class="game-btn py-3 rounded-lg font-bold text-lg">85</button>
                    </div>
                    <div id="feedback-1" class="hidden mt-3 text-center text-sm font-bold text-green-400">
                        âœ… å®Œç¾ï¼(27+3) + (48+2) = 30 + 50 = 80
                    </div>
                </div>
            </div>

            <!-- STAGE 2: è¿›é˜¶é­”æ³• -->
            <div class="space-y-4 fade-in">
                <div class="dialogue-box teacher-msg rounded-xl p-4">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-2)">è€å¸ˆ</div>
                    <p class="text-base leading-relaxed">è¿™å°±æ˜¯"å‡‘å"çš„é­”åŠ›ã€‚å†æ¥çœ‹ä¸€ä¸ªï¼Œå¦‚æœæˆ‘ä»¬è¦ç®—äºŒåä¸ƒåŠ å››åå…«åŠ ä¸‰åŠ äºŒå‘¢ï¼Ÿ</p>
                </div>
                <div class="dialogue-box student-msg rounded-xl p-4 ml-8">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-1)">å­¦ç”Ÿ</div>
                    <p class="text-base leading-relaxed">å¥½å¤šæ•°å­—ï¼</p>
                </div>
                <div class="dialogue-box teacher-msg rounded-xl p-4">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-2)">è€å¸ˆ</div>
                    <p class="text-base leading-relaxed">åˆ«æ€•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨"åˆ†ç»„"çš„æ–¹æ³•ã€‚æ‰¾æ‰¾çœ‹ï¼Œå“ªäº›æ•°å­—åŠ èµ·æ¥èƒ½å‡‘æˆåæˆ–è€…æ•´åçš„æ•°å‘€ï¼Ÿ</p>
                </div>
                <div class="dialogue-box student-msg rounded-xl p-4 ml-8">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-1)">å­¦ç”Ÿ</div>
                    <p class="text-base leading-relaxed">æˆ‘çœ‹åˆ°äºŒåä¸ƒå’Œä¸‰å¯ä»¥å‡‘æˆä¸‰åï¼å››åå…«å’ŒäºŒå¯ä»¥å‡‘æˆäº”åï¼</p>
                </div>
                <div class="dialogue-box teacher-msg rounded-xl p-4">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-2)">è€å¸ˆ</div>
                    <p class="text-base leading-relaxed">å¤ªæ£’äº†ï¼é‚£å°±æ˜¯æŠŠèƒ½å‡‘æ•´çš„æ•°å­—å…ˆç”¨å°æ‹¬å·æ‹¬èµ·æ¥ï¼Œåƒï¼ˆäºŒåä¸ƒåŠ ä¸‰ï¼‰å†åŠ ä¸Šï¼ˆå››åå…«åŠ äºŒï¼‰ï¼Œå°±ç­‰äºä¸‰ååŠ äº”åï¼Œæœ€åæ˜¯å¤šå°‘å‘€ï¼Ÿ</p>
                </div>
                <div class="dialogue-box student-msg rounded-xl p-4 ml-8">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-1)">å­¦ç”Ÿ</div>
                    <p class="text-base leading-relaxed">ä¸‰ååŠ äº”åç­‰äºå…«åï¼è¿™æ ·ç®—çœŸæ–¹ä¾¿ï¼</p>
                </div>
                <div class="dialogue-box teacher-msg rounded-xl p-4">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-2)">è€å¸ˆ</div>
                    <p class="text-base leading-relaxed">å¦‚æœä½ å’Œçˆ¸çˆ¸å¦ˆå¦ˆå»è¶…å¸‚ä¹°ä¸œè¥¿ï¼Œå¦ˆå¦ˆè®©ä½ ç®—ä¸€ä¸‹ï¼Œå¥¹ä¹°äº†ä¸€ç›’äºŒåäº”å…ƒçš„é¥¼å¹²ï¼Œåˆä¹°äº†ä¸€ç›’äºŒåäº”å…ƒçš„ç‰›å¥¶ï¼Œè¿˜æœ‰ä¸€ç›’ä¸ƒå…ƒçš„å·§å…‹åŠ›ï¼Œå’Œä¸€ç›’ä¸‰å…ƒçš„ç³–æœã€‚æ€»å…±èŠ±äº†å¤šå°‘é’±ï¼Ÿä½ ä¼šæ€ä¹ˆç®—å‘¢ï¼Ÿ</p>
                </div>
                <div class="dialogue-box student-msg rounded-xl p-4 ml-8">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-1)">å­¦ç”Ÿ</div>
                    <p class="text-base leading-relaxed">å—¯â€¦â€¦äºŒåäº”åŠ äºŒåäº”åŠ ä¸ƒåŠ ä¸‰ï¼Ÿ</p>
                </div>

                <!-- æ’å…¥ å…³å¡ 2 -->
                <div class="cyber-card rounded-2xl p-4 mt-6 border border-dashed border-opacity-50" style="border-color: var(--accent-3);">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-base font-bold text-yellow-400">ğŸ›’ é­”æ³•æµ‹è¯• 2: è´­ç‰©è®¡ç®—</span>
                        <span class="text-sm px-2 py-1 rounded bg-yellow-400/20 text-yellow-400">+25 EXP</span>
                    </div>
                    <div class="text-base mb-4 text-center">
                        <p class="mb-2">25 + 25 + 7 + 3 = ?</p>
                        <p class="text-sm text-gray-400">è¶…å¸‚è´­ç‰©æ€»å…±å¤šå°‘é’±ï¼Ÿ</p>
                    </div>
                    <div id="level-2-options" class="grid grid-cols-2 gap-2">
                        <button onclick="checkAnswer(2, 50)" class="game-btn py-3 rounded-lg font-bold text-lg">50å…ƒ</button>
                        <button onclick="checkAnswer(2, 60)" class="game-btn py-3 rounded-lg font-bold text-lg">60å…ƒ</button>
                        <button onclick="checkAnswer(2, 55)" class="game-btn py-3 rounded-lg font-bold text-lg">55å…ƒ</button>
                        <button onclick="checkAnswer(2, 65)" class="game-btn py-3 rounded-lg font-bold text-lg">65å…ƒ</button>
                    </div>
                    <div id="feedback-2" class="hidden mt-3 text-center text-sm font-bold text-green-400">
                        âœ… æ­£ç¡®ï¼(25+25) + (7+3) = 50 + 10 = 60å…ƒ
                    </div>
                </div>
            </div>

            <!-- STAGE 3: äº¤æ¢å¾‹ä¸ç»“åˆå¾‹ -->
            <div class="space-y-4 fade-in">
                <div class="dialogue-box teacher-msg rounded-xl p-4">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-2)">è€å¸ˆ</div>
                    <p class="text-base leading-relaxed">é™¤äº†å‡‘åå‡‘ç™¾ï¼Œæˆ‘ä»¬è¿˜æœ‰"äº¤æ¢å¥½æœ‹å‹"å’Œ"ç»“åˆå¥½ä¼™ä¼´"ã€‚"äº¤æ¢å¥½æœ‹å‹"å°±æ˜¯ï¼Œå¦‚æœå‡ ä¸ªæ•°ç›¸åŠ ï¼Œæ”¹å˜å®ƒä»¬çš„ä½ç½®ï¼Œç»“æœä¼šä¸ä¼šå˜å‘¢ï¼Ÿæ¯”å¦‚ï¼Œä¸‰åŠ äº”ç­‰äºå¤šå°‘ï¼Ÿ</p>
                </div>
                <div class="dialogue-box student-msg rounded-xl p-4 ml-8">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-1)">å­¦ç”Ÿ</div>
                    <p class="text-base leading-relaxed">å…«ï¼</p>
                </div>
                <div class="dialogue-box teacher-msg rounded-xl p-4">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-2)">è€å¸ˆ</div>
                    <p class="text-base leading-relaxed">é‚£äº”åŠ ä¸‰å‘¢ï¼Ÿ</p>
                </div>
                <div class="dialogue-box student-msg rounded-xl p-4 ml-8">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-1)">å­¦ç”Ÿ</div>
                    <p class="text-base leading-relaxed">è¿˜æ˜¯å…«ï¼</p>
                </div>
                <div class="dialogue-box teacher-msg rounded-xl p-4">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-2)">è€å¸ˆ</div>
                    <p class="text-base leading-relaxed">å¯¹ï¼Œè¿™å°±æ˜¯"äº¤æ¢å¾‹"ã€‚æˆ‘ä»¬å¯ä»¥æŠŠæ•°å­—äº¤æ¢ä½ç½®ï¼Œè®©èƒ½å‡‘æ•´çš„æ•°å­—æŒ¨åœ¨ä¸€èµ·ã€‚æ¯”å¦‚ï¼Œåä¸ƒåŠ ä¸‰åå…­åŠ å…«åä¸‰ï¼Œä½ ä¼šæ€ä¹ˆè®©å®ƒç®—å¾—æ›´å¿«ï¼Ÿ</p>
                </div>
                <div class="dialogue-box student-msg rounded-xl p-4 ml-8">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-1)">å­¦ç”Ÿ</div>
                    <p class="text-base leading-relaxed">å—¯â€¦â€¦åä¸ƒå’Œå…«åä¸‰å¯ä»¥å‡‘æˆä¸€ç™¾ï¼</p>
                </div>
                <div class="dialogue-box teacher-msg rounded-xl p-4">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-2)">è€å¸ˆ</div>
                    <p class="text-base leading-relaxed">å®Œå…¨æ­£ç¡®ï¼æˆ‘ä»¬å°±å¯ä»¥æŠŠå…«åä¸‰å’Œä¸‰åå…­äº¤æ¢ä¸€ä¸‹ä½ç½®ï¼Œå˜æˆåä¸ƒåŠ å…«åä¸‰åŠ ä¸‰åå…­ã€‚è¿™æ ·ï¼Œå…ˆç®—åä¸ƒåŠ å…«åä¸‰ç­‰äºä¸€ç™¾ï¼Œä¸€ç™¾å†åŠ ä¸‰åå…­ï¼Œå°±ç­‰äºä¸€ç™¾ä¸‰åå…­äº†ã€‚æ˜¯ä¸æ˜¯å¾ˆæ–¹ä¾¿ï¼Ÿ</p>
                </div>

                <!-- p5.js äº¤æ¢å¾‹æ¼”ç¤º -->
                <div class="cyber-card rounded-2xl p-4 my-4">
                    <div class="text-center mb-3">
                        <span class="text-md font-bold" style="color: var(--accent-1)">ğŸ“Š é­”æ³•æ¼”ç¤ºï¼šäº¤æ¢å¾‹</span>
                    </div>
                    <div id="swap-demo" class="p5-visualization" style="max-width: 100%; margin: 0 auto;"></div>
                    <div class="text-center mt-3 text-base" style="color: var(--text-secondary)">
                        ç‚¹å‡»ç”»é¢æŸ¥çœ‹äº¤æ¢è¿‡ç¨‹
                    </div>
                </div>

                <!-- æ’å…¥ å…³å¡ 3 -->
                <div class="cyber-card rounded-2xl p-4 mt-6 border border-dashed border-opacity-50" style="border-color: var(--accent-3);">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-base font-bold text-yellow-400">ğŸ”„ é­”æ³•æµ‹è¯• 3: äº¤æ¢å¾‹</span>
                        <span class="text-sm px-2 py-1 rounded bg-yellow-400/20 text-yellow-400">+25 EXP</span>
                    </div>
                    <div class="text-base mb-4 text-center">
                        <p class="mb-2">17 + 36 + 83 = ?</p>
                        <p class="text-sm text-gray-400">ä½¿ç”¨äº¤æ¢å¾‹ç®€åŒ–è®¡ç®—ï¼</p>
                    </div>
                    <div id="level-3-options" class="grid grid-cols-2 gap-2">
                        <button onclick="checkAnswer(3, 126)" class="game-btn py-3 rounded-lg font-bold text-lg">126</button>
                        <button onclick="checkAnswer(3, 136)" class="game-btn py-3 rounded-lg font-bold text-lg">136</button>
                        <button onclick="checkAnswer(3, 146)" class="game-btn py-3 rounded-lg font-bold text-lg">146</button>
                        <button onclick="checkAnswer(3, 130)" class="game-btn py-3 rounded-lg font-bold text-lg">130</button>
                    </div>
                    <div id="feedback-3" class="hidden mt-3 text-center text-sm font-bold text-green-400">
                        âœ… å¤ªæ£’äº†ï¼(17+83) + 36 = 100 + 36 = 136
                    </div>
                </div>
            </div>

            <!-- STAGE 4: æå–å…¬å› æ•° -->
            <div class="space-y-4 fade-in">
                <div class="dialogue-box teacher-msg rounded-xl p-4">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-2)">è€å¸ˆ</div>
                    <p class="text-base leading-relaxed">æœ€åä¸€ä¸ªå°é­”æœ¯ï¼Œå«åš"æå–å…¬å› æ•°"ã€‚æœ‰æ—¶å€™æˆ‘ä»¬ä¼šé‡åˆ°è¿™æ ·çš„ç®—å¼ï¼šäºŒåäº”ä¹˜ä¸‰ï¼ŒåŠ ä¸ŠäºŒåäº”ä¹˜ä¸ƒã€‚ä½ çœ‹ï¼Œè¿™é‡Œé¢å“ªä¸ªæ•°å­—æ˜¯é‡å¤å‡ºç°çš„ï¼Ÿ</p>
                </div>
                <div class="dialogue-box student-msg rounded-xl p-4 ml-8">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-1)">å­¦ç”Ÿ</div>
                    <p class="text-base leading-relaxed">æ˜¯äºŒåäº”ï¼</p>
                </div>
                <div class="dialogue-box teacher-msg rounded-xl p-4">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-2)">è€å¸ˆ</div>
                    <p class="text-base leading-relaxed">å¯¹ï¼äºŒåäº”å°±æ˜¯å®ƒä»¬çš„"å…¬å› æ•°"ã€‚æˆ‘ä»¬å¯ä»¥æŠŠå®ƒ"æå–"å‡ºæ¥ï¼Œæ”¾åˆ°å°æ‹¬å·å¤–é¢ï¼Œç„¶åå°æ‹¬å·é‡Œé¢å†™ä¸Šå‰©ä¸‹çš„ä¸‰åŠ ä¸ƒã€‚å°±åƒè¿™æ ·ï¼šäºŒåäº”ä¹˜ï¼ˆä¸‰åŠ ä¸ƒï¼‰ã€‚ä¸‰åŠ ä¸ƒæ˜¯å¤šå°‘å‘€ï¼Ÿ</p>
                </div>
                <div class="dialogue-box student-msg rounded-xl p-4 ml-8">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-1)">å­¦ç”Ÿ</div>
                    <p class="text-base leading-relaxed">ä¸‰åŠ ä¸ƒç­‰äºåï¼</p>
                </div>
                <div class="dialogue-box teacher-msg rounded-xl p-4">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-2)">è€å¸ˆ</div>
                    <p class="text-base leading-relaxed">é‚£äºŒåäº”ä¹˜åå‘¢ï¼Ÿ</p>
                </div>
                <div class="dialogue-box student-msg rounded-xl p-4 ml-8">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-1)">å­¦ç”Ÿ</div>
                    <p class="text-base leading-relaxed">äºŒåäº”ä¹˜åç­‰äºäºŒç™¾äº”åï¼å“‡ï¼Œè¿™ä¸ªä¹Ÿå¾ˆå¿«ï¼</p>
                </div>
                <div class="dialogue-box teacher-msg rounded-xl p-4">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-2)">è€å¸ˆ</div>
                    <p class="text-base leading-relaxed">ä½ çœ‹ï¼Œå¦‚æœæŒ‰ç…§é¡ºåºç®—ï¼ŒäºŒåäº”ä¹˜ä¸‰æ˜¯ä¸ƒåäº”ï¼ŒäºŒåäº”ä¹˜ä¸ƒæ˜¯ä¸€ç™¾ä¸ƒåäº”ï¼Œä¸ƒåäº”åŠ ä¸€ç™¾ä¸ƒåäº”æ˜¯äºŒç™¾äº”åã€‚è™½ç„¶ç»“æœä¸€æ ·ï¼Œä½†æå–å…¬å› æ•°æ˜¯ä¸æ˜¯æ›´å¿«ä¸€äº›ï¼Ÿ</p>
                </div>
                <div class="dialogue-box student-msg rounded-xl p-4 ml-8">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-1)">å­¦ç”Ÿ</div>
                    <p class="text-base leading-relaxed">æ˜¯ï¼è¿™ä¸ªä¹Ÿå¾ˆç¥å¥‡ï¼</p>
                </div>
                <div class="dialogue-box teacher-msg rounded-xl p-4">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-2)">è€å¸ˆ</div>
                    <p class="text-base leading-relaxed">åŒå­¦ä»¬ï¼Œä»Šå¤©æˆ‘ä»¬å­¦ä¹ äº†ç®€ä¾¿è¿ç®—ã€‚å®ƒèƒ½è®©æˆ‘ä»¬çš„è®¡ç®—å˜å¾—æ›´ç®€å•ã€æ›´å¿«é€Ÿã€‚æˆ‘ä»¬è¦å­¦ä¼šè§‚å¯Ÿé¢˜ç›®ï¼Œæ‰¾åˆ°èƒ½å‡‘æ•´çš„æ•°å­—ï¼Œæˆ–è€…å¯ä»¥äº¤æ¢ä½ç½®çš„æ•°å­—ï¼Œè¿™æ ·å°±èƒ½åˆå¿«åˆå‡†ç¡®åœ°ç®—å‡ºç»“æœå•¦ï¼</p>
                </div>
                <div class="dialogue-box teacher-msg rounded-xl p-4">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-2)">è€å¸ˆ</div>
                    <p class="text-base leading-relaxed">å¥½äº†ï¼Œè€å¸ˆç»™ä½ ç•™ä¸€ä¸ªå°å°çš„æŒ‘æˆ˜ï¼šè¯·ä½ ç”¨ç®€ä¾¿è¿ç®—çš„æ–¹æ³•ï¼Œç®—ä¸€ç®—ä¸‹é¢è¿™é“é¢˜ï¼šå››åä¹åŠ äºŒåäº”åŠ ä¸ƒåäº”åŠ ä¸€ã€‚</p>
                </div>

                <!-- BOSS æˆ˜ -->
                <div class="cyber-card rounded-2xl p-5 border-red-500/50 mt-6">
                    <div class="flex justify-center mb-4">
                        <span class="px-4 py-2 rounded-full text-sm font-bold bg-red-600 text-white shadow-lg shadow-red-500/50">âš”ï¸ BOSS FIGHT</span>
                    </div>
                    
                    <div class="text-center space-y-4">
                        <div class="hologram p-4 rounded-xl">
                            <h3 class="text-red-400 font-bold mb-2 text-lg">Î© ç»ˆææŒ‘æˆ˜</h3>
                            <p class="text-base mb-1">è®¡ç®—: <span class="text-white">49 + 25 + 75 + 1</span></p>
                            <p class="text-sm text-gray-400">ä½¿ç”¨ç®€ä¾¿è¿ç®—é­”æ³•ï¼</p>
                        </div>

                        <div id="boss-interaction">
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="checkBoss(140)" class="game-btn py-3 rounded-lg font-bold text-base text-red-300 border-red-500/30 hover:border-red-500">140</button>
                                <button onclick="checkBoss(150)" class="game-btn py-3 rounded-lg font-bold text-base text-red-300 border-red-500/30 hover:border-red-500">150</button>
                                <button onclick="checkBoss(145)" class="game-btn py-3 rounded-lg font-bold text-base text-red-300 border-red-500/30 hover:border-red-500">145</button>
                                <button onclick="checkBoss(155)" class="game-btn py-3 rounded-lg font-bold text-base text-red-300 border-red-500/30 hover:border-red-500">155</button>
                            </div>
                        </div>
                        <div id="feedback-boss" class="hidden mt-3 text-center font-bold text-green-400 space-y-2">
                            <p class="text-xl">ğŸ‰ ä»»åŠ¡å®Œæˆï¼</p>
                            <p class="text-sm text-gray-300">ä½ å·²æŒæ¡ç®€ä¾¿è¿ç®—é­”æ³•ï¼</p>
                            <p class="text-xs text-gray-400">(49+1) + (25+75) = 50 + 100 = 150</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä»»åŠ¡æ€»ç»“ -->
        <div class="cyber-card rounded-2xl p-5">
            <h2 class="text-xl font-bold text-center mb-4" style="color: var(--accent-1)">
                ğŸ“Š é­”æ³•æŠ€èƒ½æ±‡æ€»
            </h2>
            <div class="space-y-3">
                <div class="hologram rounded-lg p-3">
                    <div class="text-base font-bold mb-2" style="color: var(--accent-1)">[ å‡‘æ•´é­”æ³• ]</div>
                    <p class="text-sm" style="color: var(--text-secondary)">æŠŠæ•°å‡‘æˆ10ã€100ã€1000ç­‰æ•´æ•°ï¼Œç®€åŒ–è®¡ç®—</p>
                </div>
                <div class="hologram rounded-lg p-3">
                    <div class="text-base font-bold mb-2" style="color: var(--accent-1)">[ åˆ†ç»„é­”æ³• ]</div>
                    <p class="text-sm" style="color: var(--text-secondary)">æŠŠèƒ½å‡‘æ•´æˆ–å¥½ç®—çš„æ•°å…ˆç®—ï¼Œå‡å°‘æ­¥éª¤</p>
                </div>
                <div class="hologram rounded-lg p-3">
                    <div class="text-base font-bold mb-2" style="color: var(--accent-1)">[ äº¤æ¢å¾‹ ]</div>
                    <p class="text-sm" style="color: var(--text-secondary)">æ”¹å˜æ•°çš„ä½ç½®ä½†ä¸æ”¹å˜ç»“æœ</p>
                </div>
                <div class="hologram rounded-lg p-3">
                    <div class="text-base font-bold mb-2" style="color: var(--accent-1)">[ æå–å…¬å› æ•° ]</div>
                    <p class="text-sm" style="color: var(--text-secondary)">å¤šä¸ªä¹˜æ³•ç®—å¼ä¸­æœ‰ç›¸åŒå› æ•°æ—¶ï¼Œæå–å‡ºæ¥</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€
        let energy = 0;
        const totalEnergy = 100;

        // ä¸»é¢˜åˆ‡æ¢
        function toggleTheme() {
            const body = document.body;
            const toggle = document.getElementById('theme-toggle');
            
            if (body.classList.contains('dark-theme')) {
                body.classList.remove('dark-theme');
                body.classList.add('light-theme');
                toggle.classList.add('active');
            } else {
                body.classList.remove('light-theme');
                body.classList.add('dark-theme');
                toggle.classList.remove('active');
            }
        }

        // éŸ³é¢‘æ§åˆ¶
        function toggleAudio() {
            const audio = document.getElementById('bg-audio');
            const control = document.getElementById('audio-control');
            
            if (audio.paused) {
                audio.play();
                control.classList.add('rotating');
            } else {
                audio.pause();
                control.classList.remove('rotating');
            }
        }

        // æ›´æ–°èƒ½é‡æ¡
        function updateEnergy(amount) {
            energy = Math.min(energy + amount, totalEnergy);
            document.getElementById('energy-bar').style.width = `${energy}%`;
            document.getElementById('energy-text').innerText = `${energy} / 100`;
        }

        // æ£€æŸ¥ç­”æ¡ˆ
        function checkAnswer(level, answer) {
            const correctAnswers = {
                1: 80,  // 27+48+3+2
                2: 60,  // 25+25+7+3
                3: 136  // 17+36+83
            };
            
            const correct = correctAnswers[level];
            const feedback = document.getElementById(`feedback-${level}`);
            const btns = document.querySelectorAll(`#level-${level}-options button`);
            
            if (answer === correct) {
                feedback.classList.remove('hidden');
                updateEnergy(25);
                btns.forEach(btn => {
                    if (parseInt(btn.innerText) === correct) btn.classList.add('correct');
                    else btn.classList.add('opacity-50');
                    btn.disabled = true;
                });
            } else {
                btns.forEach(btn => {
                    if (parseInt(btn.innerText) === answer) {
                        btn.classList.add('wrong');
                        setTimeout(() => btn.classList.remove('wrong'), 500);
                    }
                });
            }
        }

        // æ£€æŸ¥Bosså…³å¡
        function checkBoss(answer) {
            const correctAnswer = 150; // 49+25+75+1
            const feedback = document.getElementById('feedback-boss');
            const interaction = document.getElementById('boss-interaction');
            const btns = document.querySelectorAll('#boss-interaction button');

            if (answer === correctAnswer) {
                updateEnergy(25);
                btns.forEach(btn => {
                    if (parseInt(btn.innerText) === correctAnswer) btn.classList.add('correct');
                    else btn.classList.add('opacity-50');
                    btn.disabled = true;
                });
                
                setTimeout(() => {
                    interaction.classList.add('hidden');
                    feedback.classList.remove('hidden');
                    createFireworks();
                }, 500);
            } else {
                btns.forEach(btn => {
                    if (parseInt(btn.innerText) === answer) {
                        btn.classList.add('wrong');
                        setTimeout(() => btn.classList.remove('wrong'), 500);
                    }
                });
            }
        }

        // å‡‘ååŠ¨ç”»æ¼”ç¤º (p5.js instance mode)
        const groupingSketch = function(p) {
            let numbers = [8, 5, 2];
            let positions = [];
            let stage = 0;
            let timer = 0;
            let canvasWidth = 400;
            let canvasHeight = 250;
            
            p.setup = function() {
                const container = document.getElementById('grouping-demo');
                canvasWidth = Math.min(container.offsetWidth, 400);
                canvasHeight = canvasWidth * 0.625;
                
                const canvas = p.createCanvas(canvasWidth, canvasHeight);
                canvas.parent('grouping-demo');
                
                initPositions();
            };
            
            function initPositions() {
                positions = [];
                const scale = canvasWidth / 400;
                positions.push({ x: 80 * scale, y: 125 * scale, num: 8, color: '#f87171' });
                positions.push({ x: 200 * scale, y: 125 * scale, num: 5, color: '#fbbf24' });
                positions.push({ x: 320 * scale, y: 125 * scale, num: 2, color: '#34d399' });
            }
            
            p.draw = function() {
                p.background(10, 15, 35);
                const scale = canvasWidth / 400;
                
                timer++;
                
                // ç»˜åˆ¶æ ‡é¢˜
                p.fill(100, 200, 255);
                p.textSize(16 * scale);
                p.textAlign(p.CENTER);
                p.text('å‡‘åæ³•æ¼”ç¤º', canvasWidth / 2, 25 * scale);
                
                // ç»˜åˆ¶æ•°å­—åœ†åœˆ
                positions.forEach((pos, i) => {
                    // é«˜äº®8å’Œ2
                    if (stage >= 1 && (pos.num === 8 || pos.num === 2)) {
                        p.stroke(255, 255, 0);
                        p.strokeWeight(3 * scale);
                    } else {
                        p.noStroke();
                    }
                    
                    p.fill(pos.color);
                    p.ellipse(pos.x, pos.y, 50 * scale);
                    
                    p.fill(255);
                    p.textSize(24 * scale);
                    p.textAlign(p.CENTER, p.CENTER);
                    p.text(pos.num, pos.x, pos.y);
                });
                
                // ç»˜åˆ¶è¿æ¥çº¿
                if (stage >= 1) {
                    const pos8 = positions.find(p => p.num === 8);
                    const pos2 = positions.find(p => p.num === 2);
                    p.stroke(255, 255, 0, 150);
                    p.strokeWeight(3 * scale);
                    p.line(pos8.x, pos8.y - 30 * scale, pos2.x, pos2.y - 30 * scale);
                }
                
                // æ˜¾ç¤ºè®¡ç®—è¿‡ç¨‹
                p.fill(100, 200, 255);
                p.textSize(14 * scale);
                if (stage === 0) {
                    p.text('8 + 5 + 2', canvasWidth / 2, 200 * scale);
                } else if (stage >= 1) {
                    p.text('(8 + 2) + 5 = 10 + 5 = 15', canvasWidth / 2, 200 * scale);
                }
                
                // è‡ªåŠ¨åˆ‡æ¢é˜¶æ®µ
                if (timer > 120 && stage === 0) {
                    stage = 1;
                }
            };
            
            p.mousePressed = function() {
                stage = (stage + 1) % 2;
                timer = 0;
            };
        };
        
        new p5(groupingSketch);

        // äº¤æ¢å¾‹åŠ¨ç”»æ¼”ç¤º
        const swapSketch = function(p) {
            let particles = [];
            const numbers = [17, 36, 83];
            const colors = ['#f87171', '#fbbf24', '#34d399'];
            let stage = 0;
            let swapTime = 0;
            let canvasWidth = 400;
            let canvasHeight = 250;
            
            class Particle {
                constructor(num, color, initialX, initialY, index) {
                    this.num = num;
                    this.color = color;
                    this.r = 30;
                    this.x = initialX;
                    this.y = initialY;
                    this.targetX = initialX;
                    this.targetY = initialY;
                    this.index = index;
                    this.isHighlighted = false;
                }
                
                update() {
                    let dx = this.targetX - this.x;
                    let dy = this.targetY - this.y;
                    this.x += dx * 0.1;
                    this.y += dy * 0.1;
                }
                
                display() {
                    p.noStroke();
                    if (this.isHighlighted) {
                        p.stroke(255, 255, 0);
                        p.strokeWeight(3);
                    }
                    p.fill(this.color);
                    p.ellipse(this.x, this.y, this.r * 2);
                    
                    p.fill(255);
                    p.textAlign(p.CENTER, p.CENTER);
                    p.textSize(16);
                    p.text(this.num, this.x, this.y);
                }
                
                setTarget(tx, ty) {
                    this.targetX = tx;
                    this.targetY = ty;
                }
            }
            
            p.setup = function() {
                const container = document.getElementById('swap-demo');
                canvasWidth = Math.min(container.offsetWidth, 400);
                canvasHeight = canvasWidth * 0.625;
                
                const canvas = p.createCanvas(canvasWidth, canvasHeight);
                canvas.parent('swap-demo');
                
                initParticles();
            };
            
            function initParticles() {
                particles = [];
                const scale = canvasWidth / 400;
                const targetY = 125 * scale;
                
                particles.push(new Particle(17, colors[0], 80 * scale, targetY, 0));
                particles.push(new Particle(36, colors[1], 200 * scale, targetY, 1));
                particles.push(new Particle(83, colors[2], 320 * scale, targetY, 2));
            }
            
            p.draw = function() {
                p.background(10, 15, 35);
                const scale = canvasWidth / 400;
                
                p.fill(100, 200, 255);
                p.textSize(16 * scale);
                p.textAlign(p.CENTER);
                
                if (stage === 0) {
                    p.text('åˆå§‹: 17 + 36 + 83', canvasWidth / 2, 25 * scale);
                } else if (stage === 1) {
                    p.text('äº¤æ¢ä¸­...', canvasWidth / 2, 25 * scale);
                } else {
                    p.text('ç®€ä¾¿: (17 + 83) + 36 = 136', canvasWidth / 2, 25 * scale);
                }
                
                particles.forEach(pt => {
                    pt.update();
                    pt.display();
                });
                
                if (stage === 1) {
                    swapTime++;
                    if (swapTime > 30) {
                        const scale = canvasWidth / 400;
                        particles[0].setTarget(80 * scale, 125 * scale);
                        particles[1].setTarget(320 * scale, 125 * scale);
                        particles[2].setTarget(200 * scale, 125 * scale);
                        stage = 2;
                    }
                } else if (stage === 2) {
                    particles[0].isHighlighted = true;
                    particles[2].isHighlighted = true;
                }
            };
            
            p.mousePressed = function() {
                if (stage === 0) {
                    stage = 1;
                    swapTime = 0;
                } else if (stage === 2) {
                    initParticles();
                    stage = 0;
                }
            };
        };
        
        new p5(swapSketch);

        // P5 Background (Simple Starfield)
        function setup() {
            const canvas = createCanvas(windowWidth, windowHeight);
            canvas.parent('star-field');
            noStroke();
        }

        let stars = [];
        for (let i = 0; i < 100; i++) {
            stars.push({
                x: Math.random() * window.innerWidth,
                y: Math.random() * window.innerHeight,
                size: Math.random() * 2,
                speed: Math.random() * 0.5 + 0.1
            });
        }

        function draw() {
            clear();
            fill(255);
            for (let star of stars) {
                ellipse(star.x, star.y, star.size);
                star.y += star.speed;
                if (star.y > height) star.y = 0;
            }
        }

        function windowResized() {
            resizeCanvas(windowWidth, windowHeight);
        }

        // Fireworks for victory
        function createFireworks() {
            const colors = ['#00d4ff', '#7c3aed', '#f59e0b', '#ef4444'];
            for(let i=0; i<50; i++) {
                const div = document.createElement('div');
                div.style.position = 'fixed';
                div.style.left = '50%';
                div.style.top = '50%';
                div.style.width = '10px';
                div.style.height = '10px';
                div.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                div.style.borderRadius = '50%';
                div.style.transition = 'all 1s ease-out';
                div.style.zIndex = '100';
                document.body.appendChild(div);

                const angle = Math.random() * Math.PI * 2;
                const dist = Math.random() * 200 + 50;
                
                setTimeout(() => {
                    div.style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px) scale(0)`;
                    div.style.opacity = '0';
                }, 10);

                setTimeout(() => div.remove(), 1000);
            }
        }
    </script>
</body>
</html>