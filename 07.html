<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°å­¦å†’é™©ï¼šä½™æ•°æ˜Ÿçƒæ¢ç´¢</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@2.1.1/lib/p5.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@4.0.0/tex-mml-chtml.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Orbitron', 'PingFang SC', sans-serif;
            transition: all 0.3s ease;
            font-size: 16px;
        }
        
        /* æ˜æš—ä¸»é¢˜å˜é‡ */
        .light-theme {
            --bg-primary: #f0f4ff;
            --bg-secondary: #ffffff;
            --text-primary: #1a1a2e;
            --text-secondary: #4a5568;
            --accent-1: #00d4ff;
            --accent-2: #7c3aed;
            --accent-3: #f59e0b;
            --border-glow: rgba(0, 212, 255, 0.15); /* Reduced opacity */
            --border-line: rgba(0, 212, 255, 0.2); /* New subtle border var */
            --card-shadow: rgba(0, 0, 0, 0.05);
        }
        
        .dark-theme {
            --bg-primary: #0a0e27;
            --bg-secondary: #161b33;
            --text-primary: #e0e7ff;
            --text-secondary: #a5b4fc;
            --accent-1: #00ffff;
            --accent-2: #a855f7;
            --accent-3: #fbbf24;
            --border-glow: rgba(0, 255, 255, 0.2);
            --border-line: rgba(0, 255, 255, 0.3); /* New subtle border var */
            --card-shadow: rgba(0, 255, 255, 0.1);
        }
        
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .cyber-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-line); /* Thinner, subtle border */
            box-shadow: 0 0 20px var(--card-shadow), inset 0 0 20px rgba(124, 58, 237, 0.05);
            position: relative;
            overflow: hidden;
        }
        
        .cyber-card::before {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            right: -1px;
            bottom: -1px;
            background: linear-gradient(45deg, var(--accent-1), var(--accent-2), var(--accent-1));
            z-index: -1;
            filter: blur(10px);
            opacity: 0.15; /* Reduced glow opacity */
            animation: glow 3s ease-in-out infinite;
        }
        
        @keyframes glow {
            0%, 100% { opacity: 0.15; }
            50% { opacity: 0.3; }
        }
        
        .neon-text {
            text-shadow: 0 0 10px var(--border-glow);
        }
        
        .game-btn {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(124, 58, 237, 0.1));
            border: 1px solid var(--border-line);
            color: var(--text-primary);
            box-shadow: 0 0 10px var(--border-glow);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .game-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }
        
        .game-btn:hover::before {
            left: 100%;
        }
        
        .game-btn:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(124, 58, 237, 0.2));
            box-shadow: 0 0 15px var(--border-glow);
            border-color: var(--accent-1);
        }
        
        .game-btn:active {
            transform: translateY(0);
        }

        .game-btn.correct {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.2);
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.4);
        }

        .game-btn.wrong {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.2);
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .hologram {
            background: linear-gradient(135deg, rgba(0,212,255,0.05), rgba(124,58,237,0.05));
            backdrop-filter: blur(5px);
            border: 1px solid var(--border-line);
        }
        
        .theme-toggle {
            width: 60px;
            height: 30px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-line);
            border-radius: 15px;
            position: relative;
            cursor: pointer;
            box-shadow: 0 0 5px var(--border-glow);
        }
        
        .theme-toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 0 5px var(--accent-1);
        }
        
        .theme-toggle.active .theme-toggle-slider {
            transform: translateX(30px);
        }
        
        .message-terminal {
            background: rgba(0, 212, 255, 0.03);
            border-left: 2px solid var(--border-line);
            font-family: 'Courier New', monospace;
        }
        
        .scan-line {
            position: absolute;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--border-line), transparent);
            animation: scan 3s linear infinite;
            opacity: 0.5;
        }
        
        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }
        
        .star-field {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
            opacity: 0.6;
        }
        
        input[type="text"] {
            background: var(--bg-secondary);
            border: 1px solid var(--border-line);
            color: var(--text-primary);
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
        }
        
        input[type="text"]:focus {
            border-color: var(--accent-1);
            outline: none;
        }
        
        input[type="text"]::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }
        
        .dialogue-box {
            position: relative;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .teacher-msg {
            background: linear-gradient(135deg, rgba(124,58,237,0.1), rgba(168,85,247,0.1));
            border-left: 2px solid var(--accent-2);
        }
        
        .student-msg {
            background: linear-gradient(135deg, rgba(0,212,255,0.1), rgba(0,255,255,0.1));
            border-right: 2px solid var(--accent-1);
        }
        
        .hp-bar {
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--border-line);
            overflow: hidden;
        }
        
        .hp-fill {
            background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
            height: 100%;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 10px var(--accent-1);
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-forward;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .locked-section {
            filter: blur(5px) grayscale(0.8);
            pointer-events: none;
            opacity: 0.5;
            transition: all 0.5s ease;
        }
        
        
        .unlocked-section {
            filter: blur(0) grayscale(0);
            opacity: 1;
            pointer-events: all;
        }

        /* éŸ³é¢‘æŒ‰é’®æ—‹è½¬åŠ¨ç”» */
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .rotating {
            animation: rotate 2s linear infinite;
        }
    </style>
</head>
<body class="dark-theme">
    <script>
        // æ ¹æ®URLå‚æ•°åŠ è½½ä¸»é¢˜
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const theme = urlParams.get('theme');
            
            if (theme === 'light') {
                document.body.classList.remove('dark-theme');
                document.body.classList.add('light-theme');
            } else if (theme === 'dark') {
                document.body.classList.remove('light-theme');
                document.body.classList.add('dark-theme');
            }
            // å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œä¿æŒé»˜è®¤çš„ dark-theme
        })();
    </script>
    <div id="star-field" class="star-field"></div>
    
    <!-- æ¸¸æˆç•Œé¢é¡¶éƒ¨ -->
    <div class="sticky top-0 z-50 cyber-card rounded-b-3xl" style="position: sticky; top: 0;">
        <div class="p-4">
            
            <!-- æ¸¸æˆæ ‡é¢˜ -->
            <h1 class="text-2xl font-black text-center neon-text mb-2">
                æ•°å­¦å†’é™©ï¼šä½™æ•°æ˜Ÿçƒ
            </h1>
            <p class="text-base text-center" style="color: var(--text-secondary)">
                [ MISSION: è§£é”åŒä½™å®šç†çš„ç§˜å¯† ]
            </p>
            
            <!-- èƒ½é‡æ¡ -->
            <div class="mt-4">
                <div class="flex justify-between text-sm mb-1" style="color: var(--text-secondary)">
                    <span>çŸ¥è¯†èƒ½é‡</span>
                    <span id="energy-text">0 / 100</span>
                </div>
                <div class="hp-bar rounded-full h-4">
                    <div id="energy-bar" class="hp-fill rounded-full" style="width: 0%"></div>
                </div>
            </div>

            <!-- éŸ³é¢‘æ’­æ”¾å™¨ï¼ˆéšè—ï¼‰ -->
            <audio id="bg-audio" style="display: none;">
                <source src="https://cdn.jsdelivr.net/gh/x-maths/xhtml@20251209/audio/L1_07.wav" type="audio/wav">
            </audio>
        </div>
    </div>

    <!-- éŸ³é¢‘æ§åˆ¶æŒ‰é’®ï¼ˆå³ä¸‹è§’ï¼‰ -->
    <div id="audio-control" onclick="toggleAudio()" style="position: fixed; bottom: 80px; right: 20px; z-index: 40; cursor: pointer; width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-1), var(--accent-2)); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 20px var(--border-glow); transition: all 0.3s ease;">
        <span style="font-size: 28px;">ğŸµ</span>
    </div>

    <div class="max-w-md mx-auto px-4 py-6 space-y-6 pb-24">
        <!-- ä»»åŠ¡ç®€æŠ¥ -->
        <div class="cyber-card rounded-2xl p-5 relative">
            <div class="scan-line"></div>
            <div class="flex items-center gap-3 mb-3">
                <div class="w-10 h-10 rounded-full" style="background: linear-gradient(135deg, var(--accent-1), var(--accent-2)); display: flex; align-items: center; justify-content: center;">
                    <span class="text-xl">ğŸ“¡</span>
                </div>
                <h2 class="text-xl font-bold">ä»»åŠ¡ç®€æŠ¥</h2>
            </div>
            <div class="space-y-2 text-base" style="color: var(--text-secondary)">
                <p>æŒ‡æŒ¥å®˜ï¼Œæ¬¢è¿æ¥åˆ°ä½™æ•°æ˜Ÿçƒï¼</p>
                <p>å®Œæˆå¯¹è¯ç‰¹è®­ï¼Œè§£é”åŒä½™å®šç†çš„ç»ˆæç§˜å¯†ï¼</p>
            </div>
        </div>

        <!-- å‰§æƒ…æµ -->
        <div id="story-stream" class="space-y-6">
            
            <!-- STAGE 1: å¼•å…¥ -->
            <div id="stage-1" class="space-y-4 fade-in">
                <div class="dialogue-box teacher-msg rounded-xl p-4">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-2)">è€å¸ˆ</div>
                    <p class="text-base leading-relaxed">åŒå­¦ä»¬ï¼Œå¤§å®¶æœ‰æ²¡æœ‰é‡åˆ°è¿‡è¿™æ ·çš„æƒ…å†µï¼šåˆ†è›‹ç³•ã€åˆ†ç³–æœçš„æ—¶å€™ï¼Œåˆšå¥½åˆ†å®Œçš„æƒ…å†µä¸å¤šï¼Œæ˜¯ä¸æ˜¯ç»å¸¸ä¼šå‰©ä¸‹ä¸€ç‚¹ç‚¹å‘¢ï¼Ÿ</p>
                </div>
                <div class="dialogue-box student-msg rounded-xl p-4 ml-8">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-1)">å­¦ç”Ÿ</div>
                    <p class="text-base leading-relaxed">æœ‰æœ‰æœ‰ï¼æˆ‘åˆ†é¥¼å¹²çš„æ—¶å€™å°±å¸¸å¸¸å‰©ä¸‹å‡ å—ï¼</p>
                </div>
                <div class="dialogue-box teacher-msg rounded-xl p-4">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-2)">è€å¸ˆ</div>
                    <p class="text-base leading-relaxed">å“ˆå“ˆï¼Œå¯¹å•¦ï¼ä»Šå¤©æˆ‘ä»¬è¦è®¤è¯†çš„å°±æ˜¯è¿™ä¸ªâ€œå‰©ä¸‹ä¸€ç‚¹ç‚¹â€çš„å°ä¼™ä¼´ï¼Œå®ƒåœ¨æ•°å­¦é‡Œæœ‰ä¸ªå¥½å¬çš„åå­—ï¼Œå«åšâ€œä½™æ•°â€ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬æœ‰åä¸ªè‹¹æœï¼Œåˆ†ç»™ä¸‰ä½å°æœ‹å‹ï¼Œæ¯äººåˆ†å‡ ä¸ªï¼Ÿè¿˜å‰©å‡ ä¸ªå‘€ï¼Ÿ</p>
                </div>
                
                <!-- p5.js ä½™æ•°åŠ¨ç”»æ¼”ç¤º -->
                <div class="cyber-card rounded-2xl p-4 my-4">
                    <div class="text-center mb-3">
                        <span class="text-md font-bold" style="color: var(--accent-1)">ğŸ“Š å¯è§†åŒ–æ¼”ç¤º</span>
                    </div>
                    <div id="remainder-demo" class="rounded-lg overflow-hidden" style="background: rgba(0,0,0,0.2); max-width: 100%; margin: 0 auto;"></div>
                    <div class="text-center mt-3 text-base" style="color: var(--text-secondary)">
                        10 Ã· 3 = 3 ... 1
                    </div>
                </div>
                
                <div class="dialogue-box student-msg rounded-xl p-4 ml-8">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-1)">å­¦ç”Ÿ</div>
                    <p class="text-base leading-relaxed">æ¯äººåˆ†ä¸‰ä¸ªï¼Œè¿˜å‰©ä¸€ä¸ªï¼</p>
                </div>
                <div class="dialogue-box teacher-msg rounded-xl p-4">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-2)">è€å¸ˆ</div>
                    <p class="text-base leading-relaxed">å¤ªæ£’äº†ï¼è¿™é‡Œâ€œå‰©ä¸‹ä¸€ä¸ªâ€çš„â€œä¸€â€ï¼Œå°±æ˜¯ä½™æ•°ã€‚åœ¨é™¤æ³•é‡Œï¼Œæˆ‘ä»¬å†™æˆâ€œåé™¤ä»¥ä¸‰ç­‰äºä¸‰ï¼Œä½™ä¸€â€ã€‚è®°ä½å“¦ï¼Œè¿™ä¸ªä½™æ•°å‘€ï¼Œå®ƒæ€»æ˜¯ä¼šæ¯”æˆ‘ä»¬ç”¨æ¥é™¤çš„é‚£ä¸ªæ•°ï¼Œä¹Ÿå°±æ˜¯â€œé™¤æ•°â€ï¼Œè¦å°ã€‚å°±åƒåˆ†è‹¹æœï¼Œä¸å¯èƒ½å‰©ä¸‹ä¸‰ä¸ªæˆ–æ›´å¤šï¼Œä¸ç„¶è¿˜èƒ½å†åˆ†å‡ºå»å‘¢ï¼</p>
                </div>

                <!-- æ’å…¥ å…³å¡ 1 -->
                <div class="cyber-card rounded-2xl p-4 mt-6 border border-dashed border-opacity-50" style="border-color: var(--accent-3);">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-base font-bold text-yellow-400">âš¡ çªå‘æµ‹è¯•: åŸºç¡€è®¡ç®—</span>
                        <span class="text-sm px-2 py-1 rounded bg-yellow-400/20 text-yellow-400">+33 EXP</span>
                    </div>
                    <div class="text-base mb-4 text-center">
                        <p class="mb-2">17 ä¸ªæ•°æ®åŒ… Ã· 5 ä¸ªèŠ‚ç‚¹</p>
                        <p class="text-sm text-gray-400">ä½™æ•°æ˜¯å¤šå°‘ï¼Ÿ</p>
                    </div>
                    <div id="level-1-options" class="grid grid-cols-4 gap-2">
                        <button onclick="checkAnswer(1, 1)" class="game-btn py-3 rounded-lg font-bold text-lg">1</button>
                        <button onclick="checkAnswer(1, 2)" class="game-btn py-3 rounded-lg font-bold text-lg">2</button>
                        <button onclick="checkAnswer(1, 3)" class="game-btn py-3 rounded-lg font-bold text-lg">3</button>
                        <button onclick="checkAnswer(1, 4)" class="game-btn py-3 rounded-lg font-bold text-lg">4</button>
                    </div>
                    <div id="feedback-1" class="hidden mt-3 text-center text-sm font-bold text-green-400">
                        âœ… å›ç­”æ­£ç¡®ï¼
                    </div>
                </div>
            </div>

            <!-- STAGE 2: è¿›é˜¶ -->
            <div class="space-y-4 fade-in">
                <div class="dialogue-box student-msg rounded-xl p-4 ml-8">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-1)">å­¦ç”Ÿ</div>
                    <p class="text-base leading-relaxed">å“¦ï¼ŒåŸæ¥ä½™æ•°ä¸èƒ½æ¯”é™¤æ•°å¤§å‘€ï¼é‚£å®ƒèƒ½æ˜¯é›¶å—ï¼Ÿ</p>
                </div>
                <div class="dialogue-box teacher-msg rounded-xl p-4">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-2)">è€å¸ˆ</div>
                    <p class="text-base leading-relaxed">å¥½é—®é¢˜ï¼å½“ç„¶å¯ä»¥å•¦ï¼å¦‚æœåˆšå¥½åˆ†å®Œäº†ï¼Œæ²¡æœ‰å‰©ä¸‹ï¼Œé‚£ä½™æ•°å°±æ˜¯é›¶ã€‚æ¯”å¦‚åä¸ªè‹¹æœåˆ†ç»™äº”ä½å°æœ‹å‹ï¼Œæ¯äººåˆ†ä¸¤ä¸ªï¼Œä¸€ä¸ªä¸å‰©ï¼Œä½™æ•°å°±æ˜¯é›¶ã€‚</p>
                </div>
                <div class="dialogue-box teacher-msg rounded-xl p-4">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-2)">è€å¸ˆ</div>
                    <p class="text-base leading-relaxed">é™¤äº†ä½™æ•°ï¼Œæˆ‘ä»¬ä»Šå¤©è¦è®¤è¯†çš„ç¬¬äºŒä¸ªå¥½æœ‹å‹ï¼Œå«åšâ€œåŒä½™â€ã€‚å¬èµ·æ¥æœ‰ç‚¹æ·±å¥¥ï¼Œå…¶å®å®ƒå¯æœ‰è¶£äº†ï¼ä½ ä»¬æƒ³ä¸€æƒ³ï¼Œæ•°å­—å…«é™¤ä»¥äº”ä½™æ•°æ˜¯å¤šå°‘ï¼Ÿ</p>
                </div>
                <div class="dialogue-box student-msg rounded-xl p-4 ml-8">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-1)">å­¦ç”Ÿ</div>
                    <p class="text-base leading-relaxed">å…«é™¤ä»¥äº”ï¼Œä½™æ•°æ˜¯ä¸‰ï¼</p>
                </div>
                <div class="dialogue-box teacher-msg rounded-xl p-4">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-2)">è€å¸ˆ</div>
                    <p class="text-base leading-relaxed">çœŸèªæ˜ï¼é‚£æ•°å­—åä¸‰é™¤ä»¥äº”ï¼Œä½™æ•°åˆæ˜¯å¤šå°‘å‘¢ï¼Ÿ</p>
                </div>
                <div class="dialogue-box student-msg rounded-xl p-4 ml-8">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-1)">å­¦ç”Ÿ</div>
                    <p class="text-base leading-relaxed">åä¸‰é™¤ä»¥äº”ï¼Œä¹Ÿä½™ä¸‰ï¼</p>
                </div>
                <div class="dialogue-box teacher-msg rounded-xl p-4">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-2)">è€å¸ˆ</div>
                    <p class="text-base leading-relaxed">å“‡ï¼Œä½ ä»¬å‘ç°ä»€ä¹ˆç§˜å¯†äº†å—ï¼Ÿå…«å’Œåä¸‰ï¼Œè™½ç„¶å®ƒä»¬æœ¬èº«æ˜¯ä¸åŒçš„æ•°å­—ï¼Œä½†æ˜¯å®ƒä»¬é™¤ä»¥äº”ä¹‹åï¼Œä½™æ•°éƒ½æ˜¯ä¸‰ï¼å½“ä¸¤ä¸ªæ•°è¢«åŒä¸€ä¸ªæ•°é™¤ï¼Œå¾—åˆ°çš„ä½™æ•°éƒ½ä¸€æ ·çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±è¯´è¿™ä¸¤ä¸ªæ•°â€œåŒä½™â€ã€‚è¿™ä¸ªâ€œåŒä¸€ä¸ªæ•°â€ï¼Œæ¯”å¦‚åˆšæ‰çš„â€œäº”â€ï¼Œæˆ‘ä»¬å°±æŠŠå®ƒå«åšâ€œæ¨¡æ•°â€ã€‚</p>
                </div>
                <div class="dialogue-box student-msg rounded-xl p-4 ml-8">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-1)">å­¦ç”Ÿ</div>
                    <p class="text-base leading-relaxed">è€å¸ˆï¼Œé‚£â€œåŒä½™â€æœ‰ä»€ä¹ˆç”¨å‘€ï¼Ÿå®ƒæ˜¯ä¸æ˜¯å°±åƒæ•°å­—ä»¬çš„â€œå¥½æœ‹å‹å…³ç³»â€å‘€ï¼Ÿ</p>
                </div>
                <div class="dialogue-box teacher-msg rounded-xl p-4">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-2)">è€å¸ˆ</div>
                    <p class="text-base leading-relaxed">ä½ è¯´çš„å¤ªå½¢è±¡äº†ï¼å°±æ˜¯è¿™ä¸ªæ„æ€ï¼â€œåŒä½™â€åœ¨è§£å†³ä¸€äº›æœ‰è§„å¾‹ã€æœ‰å‘¨æœŸçš„é—®é¢˜æ—¶ç‰¹åˆ«å‰å®³ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬å¹³æ—¶ç®—æ˜ŸæœŸå‡ ï¼Œå°±æ˜¯ç”¨çš„â€œåŒä½™â€æ€æƒ³å“¦ï¼</p>
                </div>
                <div class="dialogue-box teacher-msg rounded-xl p-4">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-2)">è€å¸ˆ</div>
                    <p class="text-base leading-relaxed">æˆ‘ä»¬æ¥ä¸¾ä¸ªä¾‹å­å§ï¼ä»Šå¤©æ˜ŸæœŸä¸€ï¼Œè¿‡åå¤©æ˜¯æ˜ŸæœŸå‡ å‘¢ï¼Ÿ</p>
                </div>

                <!-- æ’å…¥ å…³å¡ 2 -->
                <div class="cyber-card rounded-2xl p-4 mt-6 border border-dashed border-opacity-50" style="border-color: var(--accent-3);">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-base font-bold text-yellow-400">ğŸ•‘ çªå‘æµ‹è¯•: æ—¶é—´å¾ªç¯</span>
                        <span class="text-sm px-2 py-1 rounded bg-yellow-400/20 text-yellow-400">+33 EXP</span>
                    </div>
                     <div class="text-base mb-4 text-center">
                        <p class="mb-2">ä»Šå¤©æ˜¯æ˜ŸæœŸä¸€ï¼Œè¿‡äº†10å¤©æ˜¯æ˜ŸæœŸå‡ ï¼Ÿ</p>
                        <p class="text-sm text-gray-400 text-left bg-black/20 p-2 rounded mt-2">æç¤ºï¼š10 Ã· 7 = ? ... ?</p>
                    </div>
                    <div id="level-2-options" class="grid grid-cols-2 gap-2">
                        <button onclick="checkAnswer(2, 'ä¸‰')" class="game-btn py-3 rounded-lg font-bold text-base">æ˜ŸæœŸä¸‰</button>
                        <button onclick="checkAnswer(2, 'å››')" class="game-btn py-3 rounded-lg font-bold text-base">æ˜ŸæœŸå››</button>
                        <button onclick="checkAnswer(2, 'äº”')" class="game-btn py-3 rounded-lg font-bold text-base">æ˜ŸæœŸäº”</button>
                        <button onclick="checkAnswer(2, 'å…­')" class="game-btn py-3 rounded-lg font-bold text-base">æ˜ŸæœŸå…­</button>
                    </div>
                    <div id="feedback-2" class="hidden mt-3 text-center text-sm font-bold text-green-400">
                        âœ… è®¡ç®—å®Œç¾ï¼
                    </div>
                </div>
            </div>

            <!-- STAGE 3: ç»ˆæ -->
            <div class="space-y-4 fade-in">
                <div class="dialogue-box student-msg rounded-xl p-4 ml-8">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-1)">å­¦ç”Ÿ</div>
                    <p class="text-base leading-relaxed">å—¯â€¦â€¦æ˜ŸæœŸä¸€ã€æ˜ŸæœŸäºŒã€æ˜ŸæœŸä¸‰ã€æ˜ŸæœŸå››â€¦â€¦æ˜ŸæœŸå››ï¼</p>
                </div>
                <div class="dialogue-box teacher-msg rounded-xl p-4">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-2)">è€å¸ˆ</div>
                    <p class="text-base leading-relaxed">ä½ æ•°å¾—å¾ˆå¿«ï¼é‚£ä½ æ˜¯æ€ä¹ˆæƒ³çš„å‘¢ï¼Ÿ</p>
                </div>
                <div class="dialogue-box student-msg rounded-xl p-4 ml-8">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-1)">å­¦ç”Ÿ</div>
                    <p class="text-base leading-relaxed">æˆ‘çŸ¥é“æ˜ŸæœŸæ˜¯ä¸ƒå¤©ä¸€ä¸ªå¾ªç¯ï¼Œæ‰€ä»¥åå¤©é‡Œé¢æœ‰å‡ ä¸ªä¸ƒå¤©ï¼Œå‰©ä¸‹å‡ å¤©å°±å¾€åæ•°å‡ å¤©ã€‚åé™¤ä»¥ä¸ƒï¼Œä½™æ•°æ˜¯ä¸‰ï¼Œæ‰€ä»¥ä»æ˜ŸæœŸä¸€å¼€å§‹å¾€åæ•°ä¸‰å¤©ï¼Œå°±æ˜¯æ˜ŸæœŸå››ï¼</p>
                </div>
                <div class="dialogue-box teacher-msg rounded-xl p-4">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-2)">è€å¸ˆ</div>
                    <p class="text-base leading-relaxed">å¤ªæ£’äº†ï¼ä½ å°±æ˜¯ä¸ªå°å°æ•°å­¦å®¶ï¼è¿™é‡Œçš„ä¸ƒå°±æ˜¯æˆ‘ä»¬çš„â€œæ¨¡æ•°â€ï¼Œå› ä¸ºæ˜ŸæœŸæ˜¯ä¸ƒå¤©ä¸€ä¸ªå‘¨æœŸã€‚è¿™ä¸ªæ–¹æ³•å°±æ˜¯åˆ©ç”¨äº†æˆ‘ä»¬ä»Šå¤©å­¦çš„â€œåŒä½™â€æ€æƒ³å“¦ï¼å®ƒå¸®åŠ©æˆ‘ä»¬æŠŠä¸€ä¸ªå¾ˆå¤§çš„æ•°å­—ï¼Œå˜æˆäº†æ¯”è¾ƒå°çš„æ•°å­—æ¥è®¡ç®—ï¼Œæ˜¯ä¸æ˜¯å¾ˆæ–¹ä¾¿å‘¢ï¼Ÿ</p>
                </div>
                <div class="dialogue-box teacher-msg rounded-xl p-4">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-2)">è€å¸ˆ</div>
                    <p class="text-base leading-relaxed">åŒå­¦ä»¬ï¼Œä»Šå¤©æˆ‘ä»¬è®¤è¯†äº†ä¸¤ä½å¥½æœ‹å‹ã€‚â€œä½™æ•°â€æ˜¯é™¤æ³•ä¸­åˆ†å‰©ä¸‹çš„éƒ¨åˆ†ï¼Œè€Œä¸”æ€»æ¯”é™¤æ•°å°ã€‚å¦‚æœä¸¤ä¸ªæ•°é™¤ä»¥åŒä¸€ä¸ªæ•°ï¼Œä½™æ•°ç›¸åŒï¼Œé‚£ä¹ˆå®ƒä»¬å°±æ˜¯â€œåŒä½™â€çš„ï¼Œè¿™å¯¹è§£å†³å‘¨æœŸæ€§é—®é¢˜ç‰¹åˆ«æœ‰ç”¨ã€‚</p>
                </div>
                 <div class="dialogue-box teacher-msg rounded-xl p-4">
                    <div class="text-sm mb-2 font-bold" style="color: var(--accent-2)">è€å¸ˆ</div>
                    <p class="text-base leading-relaxed">é‚£ç°åœ¨è€å¸ˆæœ‰ä¸€ä¸ªå°é—®é¢˜æƒ³è€ƒè€ƒå¤§å®¶ã€‚å¦‚æœç°åœ¨æ˜¯ä¸Šåˆåç‚¹ï¼Œå†è¿‡åäº”ä¸ªå°æ—¶æ˜¯å‡ ç‚¹å‘¢ï¼Ÿï¼ˆæ³¨æ„æ˜¯ä¸Šåˆè¿˜æ˜¯ä¸‹åˆå“¦ï¼ï¼‰å¤§å®¶å¯ä»¥è¯¾åæ€è€ƒä¸€ä¸‹ï¼</p>
                </div>

                <!-- BOSS æˆ˜ -->
                <div class="cyber-card rounded-2xl p-5 border-red-500/50 mt-6">
                    <div class="flex justify-center mb-4">
                        <span class="px-4 py-2 rounded-full text-sm font-bold bg-red-600 text-white shadow-lg shadow-red-500/50">âš”ï¸ BOSS FIGHT</span>
                    </div>
                    
                    <div class="text-center space-y-4">
                        <div class="hologram p-4 rounded-xl">
                            <h3 class="text-red-400 font-bold mb-2 text-lg">Î© æ—¶ç©ºæŠ˜å </h3>
                            <p class="text-base mb-1">å½“å‰æ—¶é—´: <span class="text-white">ä¸Šåˆ 10:00</span></p>
                            <p class="text-base mb-3">æ—¶é—´è·³è·ƒ: <span class="text-yellow-400">+15 å°æ—¶</span></p>
                            <p class="text-sm text-gray-400">è¯·è®¡ç®—æ–°çš„æ—¶é—´ç‚¹ (24å°æ—¶åˆ¶ æˆ– ä¸Šåˆ/ä¸‹åˆ)</p>
                        </div>

                         <div id="boss-interaction">
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="checkBoss('å‡Œæ™¨1ç‚¹')" class="game-btn py-3 rounded-lg font-bold text-base text-red-300 border-red-500/30 hover:border-red-500">å‡Œæ™¨1ç‚¹</button>
                                <button onclick="checkBoss('ä¸‹åˆ1ç‚¹')" class="game-btn py-3 rounded-lg font-bold text-base text-red-300 border-red-500/30 hover:border-red-500">ä¸‹åˆ1ç‚¹</button>
                                <button onclick="checkBoss('å‡Œæ™¨12ç‚¹')" class="game-btn py-3 rounded-lg font-bold text-base text-red-300 border-red-500/30 hover:border-red-500">å‡Œæ™¨12ç‚¹</button>
                                <button onclick="checkBoss('å‡Œæ™¨2ç‚¹')" class="game-btn py-3 rounded-lg font-bold text-base text-red-300 border-red-500/30 hover:border-red-500">å‡Œæ™¨2ç‚¹</button>
                            </div>
                        </div>
                         <div id="feedback-3" class="hidden mt-3 text-center font-bold text-green-400 space-y-2">
                             <p class="text-xl">ğŸ‰ ä»»åŠ¡å®Œæˆï¼</p>
                             <p class="text-sm text-gray-300">ä½ å·²æŒæ¡åŒä½™ä¹‹åŠ›ï¼</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä»»åŠ¡æ€»ç»“ -->
        <div class="cyber-card rounded-2xl p-5">
            <h2 class="text-xl font-bold text-center mb-4" style="color: var(--accent-1)">
                ğŸ“Š ä»»åŠ¡æƒ…æŠ¥æ±‡æ€»
            </h2>
            <div class="space-y-3">
                <div class="hologram rounded-lg p-3">
                    <div class="text-base font-bold mb-2" style="color: var(--accent-1)">[ ä½™æ•°ç³»ç»Ÿ ]</div>
                    <p class="text-sm" style="color: var(--text-secondary)">é™¤æ³•è¿ç®—åçš„å‰©ä½™å•å…ƒï¼Œæ’å°äºé™¤æ•°åŸºæ•°</p>
                </div>
                <div class="hologram rounded-lg p-3">
                    <div class="text-base font-bold mb-2" style="color: var(--accent-1)">[ åŒä½™åè®® ]</div>
                    <p class="text-sm" style="color: var(--text-secondary)">ç›¸åŒæ¨¡æ•°ä¸‹ä½™æ•°ç›¸ç­‰çš„æ•°å€¼å…³ç³»</p>
                </div>
                <div class="hologram rounded-lg p-3">
                    <div class="text-base font-bold mb-2" style="color: var(--accent-1)">[ å®æˆ˜åº”ç”¨ ]</div>
                    <p class="text-sm" style="color: var(--text-secondary)">å‘¨æœŸæ€§é—®é¢˜ï¼ˆå¦‚æ—¶é—´ã€å¾ªç¯åˆ—è¡¨ï¼‰çš„é«˜æ•ˆè§£å†³æ–¹æ¡ˆ</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€
        let energy = 0;
        const totalEnergy = 100;

        // éŸ³é¢‘æ§åˆ¶
        function toggleAudio() {
            const audio = document.getElementById('bg-audio');
            const control = document.getElementById('audio-control');
            
            if (audio.paused) {
                audio.play();
                control.classList.add('rotating');
            } else {
                audio.pause();
                control.classList.remove('rotating');
            }
        }

        // æ›´æ–°èƒ½é‡æ¡
        function updateEnergy(amount) {
            energy = Math.min(energy + amount, totalEnergy);
            document.getElementById('energy-bar').style.width = `${energy}%`;
            document.getElementById('energy-text').innerText = `${energy} / 100`;
        }

        // æ£€æŸ¥å…³å¡1ç­”æ¡ˆ
        function checkAnswer(level, answer) {
            if (level === 1) {
                // 17 / 5 = 3 ... 2
                const correct = 2;
                const feedback = document.getElementById('feedback-1');
                const btns = document.querySelectorAll('#level-1-options button');
                
                if (answer === correct) {
                    feedback.classList.remove('hidden');
                    updateEnergy(33);
                    btns.forEach(btn => {
                        if (parseInt(btn.innerText) === correct) btn.classList.add('correct');
                        else btn.classList.add('opacity-50');
                        btn.disabled = true;
                    });
                } else {
                    // Find the button clicked and make it red
                    btns.forEach(btn => {
                         if (parseInt(btn.innerText) === answer) {
                             btn.classList.add('wrong');
                             setTimeout(() => btn.classList.remove('wrong'), 500);
                         }
                    });
                }
            } else if (level === 2) {
                // Mon + 10 days = Mon + 3 = Thu
                const correct = 'å››';
                const feedback = document.getElementById('feedback-2');
                const btns = document.querySelectorAll('#level-2-options button');
                
                if (answer === correct) {
                    feedback.classList.remove('hidden');
                    updateEnergy(33);
                    btns.forEach(btn => {
                        if (btn.innerText.includes(correct)) btn.classList.add('correct');
                        else btn.classList.add('opacity-50');
                        btn.disabled = true;
                    });
                } else {
                     btns.forEach(btn => {
                         if (btn.innerText.includes(answer)) {
                             btn.classList.add('wrong');
                             setTimeout(() => btn.classList.remove('wrong'), 500);
                         }
                    });
                }
            }
        }


        // æ£€æŸ¥Bosså…³å¡
        function checkBoss(answer) {
            // 10 + 15 = 25 = 1 (AM)
            const correctAnswer = 'å‡Œæ™¨1ç‚¹';
            const feedback = document.getElementById('feedback-3');
            const interaction = document.getElementById('boss-interaction');
            const btns = document.querySelectorAll('#boss-interaction button');

            if (answer === correctAnswer) {
                updateEnergy(34); // Total 100
                btns.forEach(btn => {
                    if (btn.innerText === correctAnswer) btn.classList.add('correct');
                    else btn.classList.add('opacity-50');
                    btn.disabled = true;
                });
                
                setTimeout(() => {
                    interaction.classList.add('hidden');
                    feedback.classList.remove('hidden');
                    // Celebration effect
                    createFireworks();
                }, 500);
            } else {
                btns.forEach(btn => {
                    if (btn.innerText === answer) {
                        btn.classList.add('wrong');
                        setTimeout(() => btn.classList.remove('wrong'), 500);
                    }
                });
            }
        }


        // ä½™æ•°æ¼”ç¤ºåŠ¨ç”» (p5.js instance mode)
        const remainderSketch = function(p) {
            let apples = [];
            let kids = [];
            let animationStep = 0;
            let stepTimer = 0;
            const totalApples = 10;
            const totalKids = 3;
            let canvasWidth = 400;
            let canvasHeight = 300;
            
            p.setup = function() {
                // è·å–å®¹å™¨å®½åº¦
                const container = document.getElementById('remainder-demo');
                canvasWidth = Math.min(container.offsetWidth, 400);
                canvasHeight = canvasWidth * 0.75; // ä¿æŒ4:3æ¯”ä¾‹
                
                const canvas = p.createCanvas(canvasWidth, canvasHeight);
                canvas.parent('remainder-demo');
                
                initPositions();
            };
            
            function initPositions() {
                apples = [];
                kids = [];
                
                // æ ¹æ®ç”»å¸ƒå®½åº¦è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
                const scale = canvasWidth / 400;
                
                // åˆå§‹åŒ–è‹¹æœä½ç½®ï¼ˆé¡¶éƒ¨ä¸€æ’ï¼‰
                for (let i = 0; i < totalApples; i++) {
                    apples.push({
                        x: (40 + (i % 5) * 70) * scale,
                        y: (40 + Math.floor(i / 5) * 60) * scale,
                        targetX: 0,
                        targetY: 0,
                        assigned: false,
                        kidIndex: -1
                    });
                }
                
                // åˆå§‹åŒ–å°æœ‹å‹ä½ç½®ï¼ˆåº•éƒ¨ï¼‰
                for (let i = 0; i < totalKids; i++) {
                    kids.push({
                        x: (80 + i * 120) * scale,
                        y: 220 * scale,
                        count: 0
                    });
                }
            }
            
            p.draw = function() {
                p.background(10, 15, 35);
                const scale = canvasWidth / 400;
                
                // ç»˜åˆ¶æ ‡é¢˜
                p.fill(100, 200, 255);
                p.textSize(16 * scale);
                p.textAlign(p.CENTER);
                p.text('10ä¸ªè‹¹æœ Ã· 3ä¸ªå°æœ‹å‹', canvasWidth / 2, 25 * scale);
                
                // åŠ¨ç”»é€»è¾‘
                stepTimer++;
                if (stepTimer > 60 && animationStep < totalApples) {
                    stepTimer = 0;
                    const apple = apples[animationStep];
                    const kidIndex = animationStep % totalKids;
                    
                    if (animationStep < 9) { // å‰9ä¸ªåˆ†é…ç»™å°æœ‹å‹
                        apple.assigned = true;
                        apple.kidIndex = kidIndex;
                        apple.targetX = kids[kidIndex].x - 30 * scale + (kids[kidIndex].count % 3) * 30 * scale;
                        apple.targetY = kids[kidIndex].y - 20 * scale - Math.floor(kids[kidIndex].count / 3) * 30 * scale;
                        kids[kidIndex].count++;
                    }
                    animationStep++;
                }
                
                // ç»˜åˆ¶å°æœ‹å‹
                for (let i = 0; i < kids.length; i++) {
                    p.fill(124, 58, 237, 150);
                    p.ellipse(kids[i].x, kids[i].y, 50 * scale, 50 * scale);
                    p.fill(255);
                    p.textSize(12 * scale);
                    p.textAlign(p.CENTER);
                    p.text('ğŸ‘¦', kids[i].x, kids[i].y + 5 * scale);
                    p.text(kids[i].count + 'ä¸ª', kids[i].x, kids[i].y + 40 * scale);
                }
                
                // ç»˜åˆ¶è‹¹æœ
                for (let i = 0; i < apples.length; i++) {
                    const apple = apples[i];
                    
                    if (apple.assigned) {
                        // ç§»åŠ¨åˆ°ç›®æ ‡ä½ç½®
                        apple.x = p.lerp(apple.x, apple.targetX, 0.1);
                        apple.y = p.lerp(apple.y, apple.targetY, 0.1);
                    }
                    
                    // ç»˜åˆ¶è‹¹æœ
                    if (i === 9 && animationStep > 9) {
                        // æœ€åä¸€ä¸ªè‹¹æœï¼ˆä½™æ•°ï¼‰ç”¨ä¸åŒé¢œè‰²
                        p.fill(255, 200, 0);
                        p.stroke(255, 150, 0);
                    } else {
                        p.fill(255, 100, 100);
                        p.stroke(200, 50, 50);
                    }
                    p.strokeWeight(2 * scale);
                    p.ellipse(apple.x, apple.y, 25 * scale, 25 * scale);
                    p.noStroke();
                    p.fill(255);
                    p.textSize(16 * scale);
                    p.text('ğŸ', apple.x, apple.y + 5 * scale);
                }
                
                // æ˜¾ç¤ºä½™æ•°æç¤º
                if (animationStep > 9) {
                    p.fill(255, 200, 0);
                    p.textSize(16 * scale);
                    p.textAlign(p.CENTER);
                    p.text('ä½™æ•°ï¼š1ä¸ªè‹¹æœ', 320 * scale, apples[9].y - 16);
                }
            };
        };
        
        // åˆ›å»ºä½™æ•°æ¼”ç¤ºåŠ¨ç”»å®ä¾‹
        new p5(remainderSketch);

        // è§£é”é˜¶æ®µåŠ¨ç”»
        function unlockStage(id) {
            const el = document.getElementById(id);
            el.classList.remove('hidden');
            // Allow layout reflow then fade in
            setTimeout(() => {
                el.classList.remove('opacity-0');
                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        // P5 Background (Simple Starfield)
        function setup() {
            const canvas = createCanvas(windowWidth, windowHeight);
            canvas.parent('star-field');
            noStroke();
        }

        let stars = [];
        for (let i = 0; i < 100; i++) {
            stars.push({
                x: Math.random() * window.innerWidth,
                y: Math.random() * window.innerHeight,
                size: Math.random() * 2,
                speed: Math.random() * 0.5 + 0.1
            });
        }

        function draw() {
            clear();
            fill(255);
            for (let star of stars) {
                ellipse(star.x, star.y, star.size);
                star.y += star.speed;
                if (star.y > height) star.y = 0;
            }
        }

        function windowResized() {
            resizeCanvas(windowWidth, windowHeight);
        }

        // Fireworks for victory
        function createFireworks() {
            // Simplified confetti/fireworks
            const colors = ['#00d4ff', '#7c3aed', '#f59e0b', '#ef4444'];
            for(let i=0; i<50; i++) {
                const div = document.createElement('div');
                div.style.position = 'fixed';
                div.style.left = '50%';
                div.style.top = '50%';
                div.style.width = '10px';
                div.style.height = '10px';
                div.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                div.style.borderRadius = '50%';
                div.style.transition = 'all 1s ease-out';
                div.style.zIndex = '100';
                document.body.appendChild(div);

                const angle = Math.random() * Math.PI * 2;
                const dist = Math.random() * 200 + 50;
                
                setTimeout(() => {
                    div.style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px) scale(0)`;
                    div.style.opacity = '0';
                }, 10);

                setTimeout(() => div.remove(), 1000);
            }
        }
    </script>
</body>
</html>